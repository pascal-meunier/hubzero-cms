name: update-code-push
on: [push]
jobs:
  push-step-1:
    runs-on: self-hosted
    steps:
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.HUBADMIN_KEY }}
        if_key_exists: replace ### replace|ignore|fail; optional (defaults to fail)
        known_hosts: |
          ${{ secrets.KNOWN_HOSTS_DEV_PURR_PURDUE_EDU }}
          ${{ secrets.KNOWN_HOSTS_STAGE_CMKC_HUBZERO_ORG }}
#    - name: dev push to stage.cmkc.hubzero.org
#      run: |
#        echo "Checking if 'freeze' file exists and conditionally stashing and pulling"
#        ssh hubadmin@stage.cmkc.hubzero.org "
#          if [ ! -f /var/www/stage/freeze ]; then
#            echo 'No freeze file found. Proceeding with stash and pull.'
#            echo \"$(date) - No freeze file found. Stashing and pulling.\" >> /var/www/stage/auto-deployments.log
#            cd /var/www/stage/;
#            git stash -u >> /var/www/stage/auto-deployments.log 2>&1;
#            git pull >> /var/www/stage/auto-deployments.log 2>&1;
#            echo \"$(date) - Stash and pull completed.\" >> /var/www/stage/auto-deployments.log
#          else
#            echo 'Freeze file exists. Skipping stash and pull.'
#            echo \"$(date) - Freeze file exists. Stash and pull skipped.\" >> /var/www/stage/auto-deployments.log
#          fi
#        "
    - name: dev push to dev.purr.purdue.edu
      run: |
        echo "Checking if 'freeze' file exists and conditionally stashing and pulling"
        ssh -o StrictHostKeyChecking=no hubadmin@dev.purr.purdue.edu "
          if [ ! -f /var/www/dev/freeze ]; then
            echo 'No freeze file found. Proceeding with stash and pull.'
            echo \"$(date) - No freeze file found. Stashing and pulling.\" >> /var/www/dev/auto-deployments.log
            cd /var/www/dev/;
            git pull origin dev >> /var/www/dev/auto-deployments.log 2>&1;
            git stash -u >> /var/www/dev/auto-deployments.log 2>&1;
            git pull --ff-only >> /var/www/dev/auto-deployments.log 2>&1;
            echo \"$(date) - Stash and pull completed.\" >> /var/www/dev/auto-deployments.log
          else
            echo 'Freeze file exists. Skipping stash and pull.'
            echo \"$(date) - Freeze file exists. Stash and pull skipped.\" >> /var/www/dev/auto-deployments.log
          fi
        "
